-- Run this in Supabase SQL Editor to fix migration history
-- This will mark all old migrations as reverted and keep only the current ones

-- First, mark all the old migrations as reverted
UPDATE supabase_migrations.schema_migrations
SET version = version || '_reverted'
WHERE version IN (
  '20250627043207', '20250627043215', '20250627043224', '20250627043232',
  '20250627050122', '20250627134915', '20250627135713', '20250628191257',
  '20250628192536', '20250628205017', '20250628205406', '20250628214620',
  '20250628214857', '20250628215314', '20250628215457', '20250628220246',
  '20250628220514', '20250628222525', '20250628235352', '20250629032559',
  '20250629040423', '20250629043623', '20250629163407', '20250701163635',
  '20250701163940', '20250701164552', '20250701174644', '20250701174809',
  '20250702001529', '20250702003033', '20250704180943', '20250704181408',
  '20250704181930', '20250704183830', '20250704184601', '20250707025630',
  '20250707030829', '20250707161132', '20250707164928', '20250707165643',
  '20250707173041', '20250707174336', '20250707174427', '20250707175159',
  '20250707175826', '20250707184331', '20250707192205', '20250707193555',
  '20250707194530', '20250708000451', '20250708022358', '20250708025949',
  '20250708032947', '20250715153000', '20250715160000', '20250716013503',
  '20250716030946', '20250716060844', '20250716115920', '20250717061800',
  '20250717061948', '20250719000000', '20250720003712', '20250721011654',
  '20250721011710', '20250721012105', '20250721012118', '20250721012129',
  '20250721012527', '20250721012545', '20250721012619', '20250721013543',
  '20250721013643', '20250721053655', '20250721065317', '20250721065633',
  '20250721070458', '20250721070952', '20250721071007', '20250721071049',
  '20250721071104', '20250721071114', '20250721075030', '20250721082019',
  '20250724014214', '20250724050427', '20250729052032', '20250729060805',
  '20250811015512', '20250811015525', '20250811124648', '20250813025850',
  '20250817024818', '20250817024825', '20250817024831', '20250817024846',
  '20250817052421', '20250818063328'
);

-- Delete these old migrations from history
DELETE FROM supabase_migrations.schema_migrations
WHERE version IN (
  '20250627043207', '20250627043215', '20250627043224', '20250627043232',
  '20250627050122', '20250627134915', '20250627135713', '20250628191257',
  '20250628192536', '20250628205017', '20250628205406', '20250628214620',
  '20250628214857', '20250628215314', '20250628215457', '20250628220246',
  '20250628220514', '20250628222525', '20250628235352', '20250629032559',
  '20250629040423', '20250629043623', '20250629163407', '20250701163635',
  '20250701163940', '20250701164552', '20250701174644', '20250701174809',
  '20250702001529', '20250702003033', '20250704180943', '20250704181408',
  '20250704181930', '20250704183830', '20250704184601', '20250707025630',
  '20250707030829', '20250707161132', '20250707164928', '20250707165643',
  '20250707173041', '20250707174336', '20250707174427', '20250707175159',
  '20250707175826', '20250707184331', '20250707192205', '20250707193555',
  '20250707194530', '20250708000451', '20250708022358', '20250708025949',
  '20250708032947', '20250715153000', '20250715160000', '20250716013503',
  '20250716030946', '20250716060844', '20250716115920', '20250717061800',
  '20250717061948', '20250719000000', '20250720003712', '20250721011654',
  '20250721011710', '20250721012105', '20250721012118', '20250721012129',
  '20250721012527', '20250721012545', '20250721012619', '20250721013543',
  '20250721013643', '20250721053655', '20250721065317', '20250721065633',
  '20250721070458', '20250721070952', '20250721071007', '20250721071049',
  '20250721071104', '20250721071114', '20250721075030', '20250721082019',
  '20250724014214', '20250724050427', '20250729052032', '20250729060805',
  '20250811015512', '20250811015525', '20250811124648', '20250813025850',
  '20250817024818', '20250817024825', '20250817024831', '20250817024846',
  '20250817052421', '20250818063328'
)
OR version LIKE '%_reverted';

-- Ensure the correct migrations are in the history in the right order
INSERT INTO supabase_migrations.schema_migrations (version, inserted_at)
VALUES 
  ('20240118_contact_submissions_rate_limit', NOW()),
  ('20250801000000_complete_schema', NOW()),
  ('20250812_add_deposit_fields', NOW()),
  ('20250813000000_add_is_facilitator_column', NOW()),
  ('20250817183000_add_skill_level_to_payments', NOW()),
  ('20250818000001_add_team_registration_to_leagues', NOW()),
  ('20250818000002_add_league_ids_to_users', NOW()),
  ('20250818000003_make_team_id_nullable_in_payments', NOW()),
  ('20250818000004_migrate_badminton_registrations', NOW())
ON CONFLICT (version) DO NOTHING;

-- Check the current migration history
SELECT version, inserted_at 
FROM supabase_migrations.schema_migrations 
ORDER BY inserted_at DESC;